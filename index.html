<!DOCTYPE html>
<html lang="en">
<head>
<script type='text/javascript' src='//pl28003164.effectivegatecpm.com/7f/34/cd/7f34cdaffe90dab74d20acc8cd8c9e0a.js'></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR TEMPMAIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        /* Custom Tailwind Configuration */
        :root {
            --toast-bg-light: #333;
            --toast-text-light: #fff;
            --toast-bg-dark: #eee;
            --toast-text-dark: #111;
        }

        html.dark {
            --toast-bg-light: #eee;
            --toast-text-light: #111;
            --toast-bg-dark: #333;
            --toast-text-dark: #fff;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Splash Screen Animation */
        #splash {
            transition: opacity 0.5s ease-in-out;
        }

        /* Toast Notifications Animation */
        @keyframes toastIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100px); opacity: 0; }
        }

        .toast-show {
            animation: toastIn 0.3s ease-out forwards;
        }
        .toast-hide {
            animation: toastOut 0.3s ease-in forwards;
        }
        /* Custom position for Policy Toast */
        .policy-toast {
            animation: none !important; /* Disable standard toast animation */
            transition: opacity 0.3s ease-in-out;
        }


        /* Custom Email Card Gradient */
        .email-card-bg {
            background-image: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        /* Custom Timer Card Gradient */
        .timer-card-bg {
            background-image: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        /* Dark Mode overrides for toast */
        .toast {
            background-color: var(--toast-bg-light);
            color: var(--toast-text-light);
        }
        html.dark .toast {
            background-color: var(--toast-bg-dark);
            color: var(--toast-text-dark);
        }
    </style>
</head>
<body> 
<script type='text/javascript' src='//pl27957120.effectivegatecpm.com/0a/89/7a/0a897a40bf17f9276bcfea9c82bd9ff3.js'></script>
class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">

    <div id="splash" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-gray-950 transition-colors duration-300">
        <div class="text-4xl font-extrabold text-indigo-600 dark:text-purple-400 mb-4 tracking-widest">AR TEMPMAIL</div>
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent dark:border-purple-400 dark:border-t-transparent rounded-full animate-spin"></div>
        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">Initializing & Creating secure email...</div>
    </div>

    <div id="app" class="max-w-md mx-auto p-4 pt-0 transition-opacity duration-500 opacity-0" style="display: none;">

        <header class="sticky top-0 z-10 py-4 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
            <div class="flex justify-between items-center">
                <div class="w-10"></div> <h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-wider">AR TEMPMAIL</h1>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" title="Toggle Dark/Light Mode">
                    <span class="material-symbols-outlined theme-icon" style="font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;">
                        light_mode
                    </span>
                </button>
            </div>
        </header>

        <div id="home-screen">

            <div class="flex space-x-3 mb-6">
                <button id="change-mail-btn" class="flex-1 px-4 py-3 text-sm font-semibold text-white bg-indigo-600 dark:bg-purple-600 rounded-xl shadow-lg hover:bg-indigo-700 dark:hover:bg-purple-700 transition-all duration-200 transform hover:scale-[1.02]">
                    <span class="material-symbols-outlined mr-2 align-middle" style="font-size: 1.25rem;">cycle</span>
                    Change Mail
                </button>
                <button id="delete-mail-btn" class="flex-1 px-4 py-3 text-sm font-semibold text-white bg-red-500 rounded-xl shadow-lg hover:bg-red-600 transition-all duration-200 transform hover:scale-[1.02]">
                    <span class="material-symbols-outlined mr-2 align-middle" style="font-size: 1.25rem;">delete_forever</span>
                    Delete Mail
                </button>
            </div>

            <div class="email-card-bg p-5 mb-6 rounded-2xl shadow-xl text-white">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-lg font-bold">Your Temporary Email</h2>
                    <span id="loading-spinner-email" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></span>
                </div>
                <div id="email-address-display" class="break-all text-2xl font-extrabold mb-4 opacity-0 transition-opacity duration-500">
                    Loading...
                </div>
                <button id="copy-btn" class="w-full py-2.5 mt-2 text-sm font-bold bg-white text-indigo-600 dark:text-purple-600 rounded-lg shadow-md hover:bg-gray-100 transition-colors duration-200 transform hover:scale-[1.01]">
                    <span class="material-symbols-outlined mr-2 align-middle" style="font-size: 1.25rem;">content_copy</span>
                    Copy to Clipboard
                </button>
            </div>

            <div class="timer-card-bg p-5 mb-6 rounded-2xl shadow-xl text-white flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold">Email Lifetime</h2>
                    <div id="timer-display" class="text-3xl font-extrabold mt-1">10:00</div>
                </div>
                <button id="extend-timer-btn" class="px-4 py-2 text-sm font-bold bg-white text-emerald-600 rounded-lg shadow-md hover:bg-gray-100 transition-colors duration-200 transform hover:scale-[1.05]">
                    <span class="material-symbols-outlined mr-1 align-middle" style="font-size: 1.25rem;">timer_10</span>
                    Extend
                </button>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Inbox</h2>
                <button id="refresh-inbox-btn" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" title="Refresh Inbox">
                    <span id="refresh-icon" class="material-symbols-outlined" style="font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;">refresh</span>
                </button>
            </div>

            <div id="inbox-list" class="space-y-3 pb-20">
                <div id="empty-inbox" class="flex flex-col items-center justify-center p-8 text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg transition-colors duration-300">
                    <span class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-600 mb-3" style="font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 48;">mail_lock</span>
                    <p class="text-lg font-semibold text-gray-600 dark:text-gray-400">Your inbox is empty</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">Waiting for incoming emails...</p>
                </div>
            </div>

        </div> <div id="email-detail-screen" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300 -mx-4 p-4">
            <header class="flex items-center mb-4 sticky top-0 bg-gray-50 dark:bg-gray-900 py-2 -mx-4 px-4 z-10">
                <button id="back-to-inbox-btn" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" title="Back to Inbox">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white ml-3">Message</h2>
            </header>

            <div id="detail-content" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl space-y-4 mb-4">
                <div id="detail-loading" class="flex flex-col items-center justify-center py-10">
                    <div class="w-8 h-8 border-4 border-indigo-500 border-t-transparent dark:border-purple-400 dark:border-t-transparent rounded-full animate-spin mb-3"></div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Loading message...</p>
                </div>

                <div id="message-data" class="hidden">
                    <h3 id="detail-subject" class="text-2xl font-extrabold text-gray-900 dark:text-white mb-4"></h3>

                    <div class="flex items-center space-x-3 mb-6">
                        <div id="sender-avatar" class="flex-shrink-0 w-12 h-12 bg-indigo-500 dark:bg-purple-500 rounded-full flex items-center justify-center text-lg font-bold text-white"></div>
                        <div>
                            <p id="detail-sender" class="text-base font-semibold text-gray-900 dark:text-white"></p>
                            <p id="detail-timestamp" class="text-sm text-gray-500 dark:text-gray-400"></p>
                        </div>
                    </div>

                    <div class="prose dark:prose-invert max-w-none text-gray-800 dark:text-gray-200 overflow-x-auto">
                        <div id="detail-body-html" class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 no-scrollbar">
                            </div>
                    </div>
                </div>
            </div>

            <div class="sticky bottom-0 bg-gray-50 dark:bg-gray-900 py-3 -mx-4 px-4 z-10">
                <button id="delete-message-btn" class="w-full flex justify-center items-center px-4 py-3 text-sm font-semibold text-white bg-red-500 rounded-xl shadow-lg hover:bg-red-600 transition-all duration-200 transform hover:scale-[1.01]">
                    <span class="material-symbols-outlined mr-2" style="font-size: 1.25rem;">delete</span>
                    Delete Message (Local Only)
                </button>
            </div>
        </div>

        <footer class="text-center py-6 text-sm text-gray-500 dark:text-gray-400">
            <p class="mb-1">
                <a href="#" class="hover:text-indigo-600 dark:hover:text-purple-400 transition-colors duration-200" onclick="showPrivacyInfo(); return false;">Privacy Policy</a> |
                <a href="#" class="hover:text-indigo-600 dark:hover:text-purple-400 transition-colors duration-200" onclick="showAboutInfo(); return false;">About AR TEMPMAIL</a>
            </p>
            <p>&copy; 2024 AR TEMPMAIL. All rights reserved.</p>
        </footer>

    </div> <div id="toast-container" class="fixed bottom-0 left-0 right-0 p-4 flex justify-center pointer-events-none z-50">
        </div>

    <script>
        const API_BASE = 'https://api.mail.tm';
        const API_TIMEOUT = 10000; // 10 seconds timeout

        // --- GLOBAL STATE ---
        let state = {
            token: null,
            email: null,
            accountId: null,
            messages: [],
            timerInterval: null,
            inboxInterval: null,
            timerStartTime: null,
            timerDuration: 600, // 10 minutes in seconds
            currentTheme: 'light',
            emailLoading: false,
        };

        // --- DOM Elements ---
        const D = {
            splash: document.getElementById('splash'),
            app: document.getElementById('app'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIcon: document.querySelector('.theme-icon'),
            emailDisplay: document.getElementById('email-address-display'),
            loadingSpinnerEmail: document.getElementById('loading-spinner-email'),
            copyBtn: document.getElementById('copy-btn'),
            changeMailBtn: document.getElementById('change-mail-btn'),
            deleteMailBtn: document.getElementById('delete-mail-btn'),
            timerDisplay: document.getElementById('timer-display'),
            extendTimerBtn: document.getElementById('extend-timer-btn'),
            refreshInboxBtn: document.getElementById('refresh-inbox-btn'),
            refreshIcon: document.getElementById('refresh-icon'),
            inboxList: document.getElementById('inbox-list'),
            emptyInbox: document.getElementById('empty-inbox'),
            homeScreen: document.getElementById('home-screen'),
            emailDetailScreen: document.getElementById('email-detail-screen'),
            backToInboxBtn: document.getElementById('back-to-inbox-btn'),
            detailLoading: document.getElementById('detail-loading'),
            messageData: document.getElementById('message-data'),
            detailSubject: document.getElementById('detail-subject'),
            detailSender: document.getElementById('detail-sender'),
            detailTimestamp: document.getElementById('detail-timestamp'),
            senderAvatar: document.getElementById('sender-avatar'),
            detailBodyHtml: document.getElementById('detail-body-html'),
            deleteMessageBtn: document.getElementById('delete-message-btn'),
            toastContainer: document.getElementById('toast-container'),
        };

        // --- UTILITY FUNCTIONS ---

        /** Fetches with a timeout and handles errors. */
        async function fetchWithTimeout(url, options = {}, timeout = API_TIMEOUT) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out.');
                }
                throw error;
            }
        }

        /** Simple function to generate a random string */
        function generateRandomString(length = 10) {
            return Math.random().toString(36).substring(2, 2 + length);
        }

        /** Formats time in MM:SS */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        /** Sanitizes HTML for display (simple method to prevent basic XSS) */
        function sanitizeHtml(html) {
            const element = document.createElement('div');
            element.innerHTML = html;
            // For this single-file demo, we rely on the browser's ability to handle simple HTML content.
            // For a production app, *always* use a library like DOMPurify for sanitization.
            return html;
        }

        /** Helper to create an avatar initial */
        function getAvatarInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        /** Helper to format message time */
        function formatMessageTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString();
        }

        // --- API FUNCTIONS ---

        /** 1. Fetch available domain */
        async function getDomain() {
            try {
                const response = await fetchWithTimeout(`${API_BASE}/domains`);
                if (!response.ok) throw new Error('Failed to fetch domains');
                const data = await response.json();
                return data['hydra:member'][0].domain;
            } catch (error) {
                console.error('getDomain error:', error);
                showToast('Failed to fetch domains. Check API.', 'error');
                throw error;
            }
        }

        /** 2. Create a new account */
        async function createAccount(domain) {
            const address = `${generateRandomString()}@${domain}`;
            const password = generateRandomString(15);
            try {
                const response = await fetchWithTimeout(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                if (!response.ok) throw new Error('Account creation failed');
                const account = await response.json();
                return { address: account.address, password, id: account['@id'] };
            } catch (error) {
                console.error('createAccount error:', error);
                showToast('Failed to create account.', 'error');
                throw error;
            }
        }

        /** 3. Get Auth Token (Login) */
        async function getToken(address, password) {
            try {
                const response = await fetchWithTimeout(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                if (!response.ok) throw new Error('Authentication failed');
                const data = await response.json();
                return data.token;
            } catch (error) {
                console.error('getToken error:', error);
                showToast('Authentication failed.', 'error');
                throw error;
            }
        }

        /** 4. Fetch Messages */
        async function fetchMessages() {
            if (!state.token) return;
            try {
                const response = await fetchWithTimeout(`${API_BASE}/messages?page=1`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });

                if (response.status === 401) {
                    showToast('Session expired. Generating new email...', 'warning');
                    await getNewEmail(); // Auto-regenerate on 401
                    return;
                }
                if (!response.ok) throw new Error('Failed to fetch messages');

                const data = await response.json();
                // Sort by newest first (id is often a proxy for time)
                state.messages = data['hydra:member'].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                updateInboxUI();
            } catch (error) {
                console.error('fetchMessages error:', error);
                showToast('Failed to check inbox.', 'error');
            }
        }

        /** 5. Get Single Message Details */
        async function fetchMessageDetails(id) {
            if (!state.token) return;
            try {
                const response = await fetchWithTimeout(`${API_BASE}/messages/${id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch message details');
                return await response.json();
            } catch (error) {
                console.error('fetchMessageDetails error:', error);
                showToast('Failed to load message details.', 'error');
                return null;
            }
        }

        /** 6. Delete Account */
        async function deleteAccount() {
            if (!state.token || !state.accountId) return;
            try {
                const response = await fetchWithTimeout(`${API_BASE}/accounts/${state.accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                if (!response.ok) throw new Error('Failed to delete account');
                console.log('Account deleted successfully.');
            } catch (error) {
                console.error('deleteAccount error:', error);
                showToast('Failed to delete account on server.', 'warning');
            }
        }

        // --- UI / LOGIC FUNCTIONS ---

        /** Shows a small notification toast at the bottom */
        function showToast(message, type = 'info') {
            const colors = {
                info: 'bg-indigo-600 dark:bg-purple-600',
                success: 'bg-emerald-600 dark:bg-green-600',
                warning: 'bg-yellow-600 dark:bg-orange-600',
                error: 'bg-red-600 dark:bg-red-700'
            };

            const toast = document.createElement('div');
            toast.className = `toast text-white px-4 py-3 rounded-xl shadow-2xl mb-4 text-sm max-w-xs transition-transform duration-300 pointer-events-auto ${colors[type]} toast-show`;
            toast.textContent = message;

            D.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('toast-show');
                toast.classList.add('toast-hide');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                }, { once: true });
            }, 3000);
        }

        /** Shows a persistent modal-like toast for policy info */
        function showPolicyToast(title, message) {
            // Remove any existing policy toasts before showing a new one
            document.querySelectorAll('.policy-toast').forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = `policy-toast text-white px-6 py-4 rounded-2xl shadow-2xl text-sm max-w-xs md:max-w-md transition-opacity duration-300 pointer-events-auto`;
            toast.style.position = 'fixed';
            toast.style.bottom = '50%';
            toast.style.left = '50%';
            toast.style.transform = 'translate(-50%, 50%)';
            toast.style.backgroundColor = 'var(--toast-bg-light)';
            toast.style.color = 'var(--toast-text-light)';
            toast.style.opacity = '0';
            toast.style.zIndex = '60';

            toast.innerHTML = `
                <div class="font-bold text-lg mb-2 border-b border-gray-600 dark:border-gray-400 pb-1">${title}</div>
                <div class="max-h-60 overflow-y-auto pr-2 no-scrollbar whitespace-pre-wrap">${message}</div>
                <button onclick="this.closest('.policy-toast').style.opacity = '0'; setTimeout(() => this.closest('.policy-toast').remove(), 300);" class="w-full mt-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg text-sm transition-colors">Close</button>
            `;

            D.toastContainer.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 10);
        }

        /** Shows Privacy Policy information (Updated with English text) */
        function showPrivacyInfo() {
            const privacyText = `
**Data Collection & Retention**
* **Emails & Account:** This app uses the **Mail.tm API**. Your temporary email address, password (randomly generated in your browser), and messages are stored by Mail.tm. Mail.tm is a disposable service where emails are stored for **only 7 days** before deletion.
* **Activity:** The Mail.tm API may log general server information (like IP address) in their server log files.
* **Local Storage:** This app only stores your **Dark Mode preference** in your browser's local storage.
* **Anonymity:** The service is designed to be **anonymous**. When you delete the mail (Change Mail/Delete Mail), the account is deleted from the server.
            `;
            showPolicyToast("ðŸ”’ Privacy Policy Summary", privacyText);
        }

        /** Shows About/API Information (Updated with English text) */
        function showAboutInfo() {
            const aboutText = `
**About AR TEMPMAIL**
* **Version:** 1.0 (Single-File Demo)
* **API Used:** This application uses the **public Mail.tm API (https://api.mail.tm)** to generate and retrieve emails.
* **Disclaimer:** This is a third-party client. We are not responsible for the Mail.tm service uptime or its internal policies.
* **Functionality:** This app provides a mobile-friendly interface for generating temporary emails, receiving messages, and managing their lifetime.
* **Limitations:** Deleting individual messages is **simulated locally**; the Mail.tm API is designed for full account deletion.
            `;
            showPolicyToast("âœ¨ About AR TEMPMAIL", aboutText);
        }

        /** Handles Dark/Light Mode toggle */
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            state.currentTheme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', state.currentTheme);
            updateThemeIcon(state.currentTheme);
        }

        /** Updates the icon based on the current theme */
        function updateThemeIcon(theme) {
            D.themeIcon.textContent = theme === 'dark' ? 'dark_mode' : 'light_mode';
        }

        /** Initializes the theme based on localStorage */
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                state.currentTheme = 'dark';
            } else {
                document.documentElement.classList.remove('dark');
                state.currentTheme = 'light';
            }
            updateThemeIcon(state.currentTheme);
        }

        /** Handles the logic for generating a new email */
        async function getNewEmail(isStartup = false) {
            if (state.emailLoading) return;
            state.emailLoading = true;

            // Cleanup previous state
            clearInterval(state.timerInterval);
            clearInterval(state.inboxInterval);
            D.emailDisplay.textContent = 'Generating...';
            D.emailDisplay.classList.remove('opacity-100');
            D.loadingSpinnerEmail.classList.remove('hidden');
            state.messages = [];
            updateInboxUI();
            
            // Delete old account if one exists
            if (!isStartup && state.token && state.accountId) {
                await deleteAccount();
            }

            try {
                const domain = await getDomain();
                const account = await createAccount(domain);
                const token = await getToken(account.address, account.password);

                state.token = token;
                state.email = account.address;
                state.accountId = account.id.split('/').pop(); // Extract ID from @id

                // Update UI
                D.emailDisplay.textContent = state.email;
                D.emailDisplay.classList.add('opacity-100');
                D.loadingSpinnerEmail.classList.add('hidden');
                
                startTimer();
                startInboxPolling();
                showToast(isStartup ? 'New email generated.' : 'New email generated!', 'success');
            } catch (error) {
                D.emailDisplay.textContent = 'Error!';
                D.loadingSpinnerEmail.classList.add('hidden');
                clearInterval(state.timerInterval);
                clearInterval(state.inboxInterval);
                console.error('getNewEmail full flow error:', error);
                showToast('Failed to generate new email. Try refreshing the page.', 'error');
            } finally {
                state.emailLoading = false;
            }
        }

        /** Copy current email address to clipboard */
        function copyToClipboard() {
            if (!state.email) return showToast('No email address to copy.', 'warning');
            
            navigator.clipboard.writeText(state.email)
                .then(() => {
                    showToast('Email address copied!', 'success');
                })
                .catch(err => {
                    // Fallback for older browsers
                    const tempInput = document.createElement('input');
                    tempInput.value = state.email;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand('copy');
                        showToast('Email address copied! (Fallback)', 'success');
                    } catch (e) {
                        showToast('Failed to copy. Please copy manually.', 'error');
                    }
                    document.body.removeChild(tempInput);
                });
        }

        /** Handles the countdown timer logic */
        function updateTimer() {
            const now = Date.now();
            const elapsed = Math.floor((now - state.timerStartTime) / 1000);
            const remaining = state.timerDuration - elapsed;

            if (remaining <= 0) {
                D.timerDisplay.textContent = '00:00';
                clearInterval(state.timerInterval);
                showToast('Timer expired! Extend or get new email.', 'warning');
                return;
            }

            D.timerDisplay.textContent = formatTime(remaining);
        }

        /** Starts or resets the timer */
        function startTimer(duration = state.timerDuration) {
            state.timerDuration = duration;
            state.timerStartTime = Date.now();
            clearInterval(state.timerInterval);
            D.timerDisplay.textContent = formatTime(duration);
            state.timerInterval = setInterval(updateTimer, 1000);
        }

        /** Extends the timer by resetting to 10 minutes */
        function extendTimer() {
            startTimer(600);
            showToast('Email lifetime extended by 10 minutes.', 'info');
        }

        /** Starts polling the inbox every 10 seconds */
        function startInboxPolling() {
            clearInterval(state.inboxInterval);
            fetchMessages(); // initial fetch
            state.inboxInterval = setInterval(fetchMessages, 10000); // 10 seconds
        }

        /** Updates the Inbox UI with messages from state.messages */
        function updateInboxUI() {
            D.inboxList.innerHTML = '';
            
            if (state.messages.length === 0) {
                D.emptyInbox.style.display = 'flex';
                D.inboxList.appendChild(D.emptyInbox);
                return;
            }

            D.emptyInbox.style.display = 'none';

            state.messages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg hover:shadow-xl cursor-pointer transition-all duration-200 transform hover:scale-[1.01]';
                item.onclick = () => openEmail(msg.id);

                const sender = msg.from ? (msg.from.name || msg.from.address) : 'Unknown Sender';
                const subject = msg.subject || 'No Subject';
                const preview = msg.intro || 'No preview available.';
                const time = formatMessageTime(msg.createdAt);

                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-bold text-indigo-600 dark:text-purple-400 truncate">${sender}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">${time.split(' ')[0]}</p>
                    </div>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white mb-1 truncate">${subject}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${preview}</p>
                `;
                D.inboxList.appendChild(item);
            });
        }

        /** Switches to the email detail screen and loads message data */
        async function openEmail(id) {
            D.homeScreen.classList.add('hidden');
            D.emailDetailScreen.classList.remove('hidden');

            D.detailLoading.classList.remove('hidden');
            D.messageData.classList.add('hidden');

            const message = await fetchMessageDetails(id);

            D.detailLoading.classList.add('hidden');
            D.messageData.classList.remove('hidden');

            if (message) {
                const senderName = message.from ? (message.from.name || message.from.address) : 'Unknown Sender';
                const senderAddress = message.from ? message.from.address : 'N/A';
                const emailBody = message.html ? sanitizeHtml(message.html) : `<p>${message.text ? message.text.replace(/\n/g, '<br>') : 'The message body could not be loaded.'}</p>`;
                
                D.detailSubject.textContent = message.subject || 'No Subject';
                D.detailSender.textContent = senderName;
                D.detailTimestamp.textContent = `${senderAddress} Â· ${formatMessageTime(message.createdAt)}`;
                D.senderAvatar.textContent = getAvatarInitial(senderName);
                D.detailBodyHtml.innerHTML = emailBody;
            } else {
                 D.detailSubject.textContent = 'Error Loading Message';
                 D.detailSender.textContent = '';
                 D.detailTimestamp.textContent = '';
                 D.senderAvatar.textContent = '!';
                 D.detailBodyHtml.innerHTML = '<p class="text-red-500">Could not retrieve message content. It might have been deleted on the server or the token is invalid.</p>';
            }

            // Mark message as read (simulated locally for this demo)
            const localMessage = state.messages.find(m => m.id === id);
            if(localMessage) localMessage.seen = true;

            // Delete button simulation
            D.deleteMessageBtn.onclick = () => {
                showToast(`Message "${D.detailSubject.textContent}" deleted (locally only).`, 'info');
                // Remove from local state
                state.messages = state.messages.filter(m => m.id !== id);
                updateInboxUI();
                // Go back to inbox
                D.backToInboxBtn.click();
            };

             // Mark message as read on Mail.tm API (optional, but good practice)
            if (!message.seen && state.token) {
                 fetchWithTimeout(`${API_BASE}/messages/${id}`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({ seen: true })
                }).catch(e => console.warn('Failed to mark as read:', e));
            }

        }

        /** Switches back to the home screen */
        function backToInbox() {
            D.emailDetailScreen.classList.add('hidden');
            D.homeScreen.classList.remove('hidden');
        }

        /** Initializes the application */
        async function initApp() {
            initTheme();
            await getNewEmail(true);

            // Hide splash screen
            D.splash.style.opacity = '0';
            setTimeout(() => {
                D.splash.style.display = 'none';
                D.app.style.display = 'block';
                D.app.classList.add('opacity-100');
            }, 500); // Wait for fade out animation
        }

        // --- EVENT LISTENERS ---
        D.themeToggle.addEventListener('click', toggleTheme);
        D.copyBtn.addEventListener('click', copyToClipboard);
        D.extendTimerBtn.addEventListener('click', extendTimer);
        D.changeMailBtn.addEventListener('click', () => {
             if (confirm("Are you sure you want to generate a brand new email? Your current inbox will be lost!")) {
                getNewEmail();
            }
        });
        D.deleteMailBtn.addEventListener('click', () => {
             if (confirm("Are you sure you want to delete this email account and generate a new one? This action is irreversible!")) {
                getNewEmail();
            }
        });
        D.refreshInboxBtn.addEventListener('click', () => {
            D.refreshIcon.classList.add('animate-spin');
            fetchMessages().finally(() => {
                setTimeout(() => D.refreshIcon.classList.remove('animate-spin'), 500); // Spin for at least 0.5s
            });
            showToast('Refreshing inbox...', 'info');
        });
        D.backToInboxBtn.addEventListener('click', backToInbox);


        // Start the application
        window.addEventListener('load', initApp);

    </script>
</body>
</html>
